const axios = require("axios");
var cookie = '\x6D\x69\x64\x3D\x59\x34\x6C\x61\x78\x51\x41\x4C\x41\x41\x48\x52\x66\x62\x56\x78\x31\x59\x74\x30\x31\x6E\x64\x50\x39\x2D\x4A\x38\x3B\x20\x69\x67\x5F\x64\x69\x64\x3D\x36\x42\x32\x41\x30\x37\x35\x34\x2D\x41\x44\x41\x39\x2D\x34\x41\x33\x41\x2D\x41\x37\x30\x30\x2D\x39\x32\x43\x35\x41\x43\x37\x36\x35\x31\x31\x33\x3B\x20\x69\x67\x5F\x6E\x72\x63\x62\x3D\x31\x3B\x20\x66\x62\x6D\x5F\x31\x32\x34\x30\x32\x34\x35\x37\x34\x32\x38\x37\x34\x31\x34\x3D\x62\x61\x73\x65\x5F\x64\x6F\x6D\x61\x69\x6E\x3D\x2E\x69\x6E\x73\x74\x61\x67\x72\x61\x6D\x2E\x63\x6F\x6D\x3B\x20\x64\x73\x5F\x75\x73\x65\x72\x5F\x69\x64\x3D\x35\x36\x36\x31\x37\x37\x38\x36\x35\x39\x31\x3B\x20\x64\x61\x74\x72\x3D\x42\x63\x65\x57\x59\x32\x6E\x47\x31\x50\x33\x61\x43\x6E\x65\x56\x30\x44\x50\x4F\x36\x6F\x59\x68\x3B\x20\x63\x73\x72\x66\x74\x6F\x6B\x65\x6E\x3D\x7A\x48\x51\x45\x4B\x67\x53\x38\x37\x5A\x55\x72\x4A\x50\x77\x68\x66\x78\x6C\x63\x38\x4F\x4D\x46\x61\x6C\x4C\x48\x63\x6C\x44\x65\x3B\x20\x64\x70\x72\x3D\x31\x2E\x32\x35\x3B\x20\x73\x65\x73\x73\x69\x6F\x6E\x69\x64\x3D\x35\x36\x36\x31\x37\x37\x38\x36\x35\x39\x31\x3A\x46\x63\x36\x50\x42\x42\x50\x78\x42\x58\x32\x31\x55\x6C\x3A\x31\x38\x3A\x41\x59\x65\x31\x4F\x31\x54\x57\x64\x52\x66\x72\x38\x71\x64\x66\x48\x49\x47\x6A\x4D\x66\x2D\x50\x63\x6E\x69\x77\x75\x55\x42\x68\x65\x50\x42\x65\x35\x37\x34\x76\x55\x41\x3B\x20\x72\x75\x72\x3D\x22\x50\x52\x4E\x2C\x35\x36\x36\x31\x37\x37\x38\x36\x35\x39\x31\x2C\x31\x37\x30\x37\x30\x37\x32\x34\x31\x32\x3A\x30\x31\x66\x37\x66\x61\x35\x63\x61\x64\x35\x64\x32\x30\x32\x38\x63\x39\x64\x61\x30\x65\x36\x62\x63\x31\x36\x37\x37\x65\x32\x30\x36\x64\x30\x66\x36\x37\x61\x64\x61\x66\x61\x34\x33\x38\x63\x64\x63\x31\x38\x34\x30\x61\x61\x30\x31\x32\x30\x34\x36\x33\x37\x31\x37\x61\x31\x35\x37\x32\x64\x65';
function searchID(url) {
	return /(?:https?:\/\/)?(?:www.)?instagram.com\/?([a-zA-Z0-9\.\_\-]+)?\/([p]+)?([reel]+)?([tv]+)?([stories]+)?\/([a-zA-Z0-9\-\_\.]+)\/?([0-9]+)?/gm.exec(url)[6]
}
exports.name = "/instagram/:type"
exports.index = async (req, res) => {
	var {
		type: type
	} = req.params;
	if ("info" == type) {
		!req.query.username && res.json({
			error: !0,
			message: "Không tìm thấy username"
		});
		const json = (await axios.get(`https://www.instagram.com/${req.query.username}/?__a=1&__d=dis`, {
			headers: {
				cookie: cookie
			}
		})).data.graphql.user;
		res.json({
			data: {
				username: json.username,
				fullname: json.full_name,
				private: json.is_private ? "Yes" : "No",
				id: json.id,
				followers: json.edge_followed_by.count,
				following: json.edge_follow.count,
				post_cout: json.edge_owner_to_timeline_media.count,
				website: json.external_url ? json.external_url : "No",
				bio: json.biography,
				picture: json.profile_pic_url_hd
			},
			author: "Nguyễn Liên Mạnh"
		})
	} else if ("videodl" == type) try {
		var {
			url: url
		} = req.query;
		!url && res.json({
			error: !0,
			message: "Không tìm thấy url"
		});
		let str = await searchID(url);
		console.log(str), axios({
			method: "get",
			url: "https://www.instagram.com/p/" + str + "/?__a=1&__d=dis",
			headers: {
				cookie: cookie
			}
		}).then((body => {
			console.log(body.data), res.json({
				author: "Nguyễn Liên Mạnh",
device_timestamp: body.data.items[0].device_timestamp,
        like_count: body.data.items[0].like_count,
        comment_count: body.data.items[0].comment_count,
        user_id: body.data.items[0].caption.user_id,
        title: body.data.items[0].caption.text,
        user_full_name: body.data.items[0].user.full_name,
video_versions: body.data.items[0].video_versions, 
        images: body.data.items[0].carousel_media,				
video_url: body.data.items[0].video_versions,
        like_count: body.data.items[0].like_count,
        caption: body.data.items[0].caption,
        user: body.data.items[0].user,
        comment_count: body.data.items[0].comment_count
			})
		}))
	} catch (e) {
		res.json({
			error: "Không thể tải video này!"
		})
	}
};